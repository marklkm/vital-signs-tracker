<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vital Signs Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        transition: background-color 0.5s, color 0.5s;
      }
      .dark-mode {
        background-color: #121212 !important;
        color: #f1f1f1 !important;
      }
      .dark-mode .table {
        color: #f1f1f1;
      }
      .form-section {
        margin-top: 1rem;
      }
      .patient-info-box {
        background-color: #e9ecef;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
      }
      .btn-burger {
        background: none;
        border: none;
        font-size: 1.5rem;
      }
      #patientPhoto {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #6c757d;
      }
      .dark-mode #patientPhoto {
        border-color: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-light px-3">
      <button
        class="btn-burger"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#sidebar"
        aria-controls="sidebar"
      >
        ☰
      </button>
      <a class="navbar-brand ms-3" href="#">Vital Signs Tracker</a>
    </nav>

    <!-- Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Menu</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column mb-4">
          <li class="nav-item">
            <a class="nav-link active" href="#">Vitals</a>
          </li>
        </ul>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="darkModeSwitch" />
          <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid p-4">
      <!-- Add New Patient -->
      <div class="form-section">
        <h2>Add New Patient</h2>
        <form id="patientForm" class="row g-3 mb-4">
          <div class="col-md-4 col-12">
            <label for="patientName" class="form-label">Patient Name</label>
            <input type="text" id="patientName" class="form-control" required />
          </div>
          <div class="col-md-4 col-12">
            <label for="dob" class="form-label">Date of Birth (DOB)</label>
            <input type="date" id="dob" class="form-control" required />
          </div>
          <div class="col-md-4 col-12">
            <label for="patientImage" class="form-label"
              >Patient Photo (optional)</label
            >
            <input
              type="file"
              id="patientImage"
              accept="image/*"
              class="form-control"
            />
          </div>
          <div class="col-md-4 col-12">
            <button type="submit" class="btn btn-success w-100 mt-4">
              Add Patient
            </button>
          </div>
        </form>

        <!-- Select Patient -->
        <div class="mb-4">
          <label for="selectPatient" class="form-label">Select Patient</label>
          <select id="selectPatient" class="form-select">
            <option value="">-- Select a patient --</option>
          </select>
        </div>

        <!-- Current Patient Info -->
        <div
          id="patientInfoDisplay"
          class="patient-info-box d-none text-center"
        >
          <img
            id="patientPhoto"
            src=""
            alt="Patient photo"
            class="img-thumbnail mb-3 d-none"
          />
          <h4>Current Patient</h4>
          <p><strong>Name:</strong> <span id="displayPatientName"></span></p>
          <p><strong>DOB:</strong> <span id="displayPatientDOB"></span></p>
        </div>
      </div>

      <!-- Vital Signs Form -->
      <div class="form-section">
        <h2>Add Vital Signs Entry</h2>
        <form id="vitalForm" class="row g-3 mb-5">
          <div class="col-md-4 col-12">
            <label for="systolic" class="form-label">Systolic BP</label>
            <input type="number" id="systolic" class="form-control" required />
          </div>
          <div class="col-md-4 col-12">
            <label for="diastolic" class="form-label">Diastolic BP</label>
            <input type="number" id="diastolic" class="form-control" required />
          </div>
          <div class="col-md-4 col-12">
            <label for="spo2" class="form-label">SpO₂ (%)</label>
            <input type="number" id="spo2" class="form-control" required />
          </div>
          <div class="col-md-4 col-12">
            <label for="pulse" class="form-label">Pulse (bpm)</label>
            <input type="number" id="pulse" class="form-control" required />
          </div>
          <div class="col-md-4 col-12">
            <label for="temperature" class="form-label">Temperature (°C)</label>
            <input
              type="number"
              id="temperature"
              class="form-control"
              step="0.1"
              required
            />
          </div>
          <div class="col-md-4 col-12">
            <label for="time" class="form-label">Time of Measurement</label>
            <input
              type="datetime-local"
              id="time"
              class="form-control"
              required
            />
            <small id="formattedTime" class="text-muted"></small>
          </div>

          <div class="col-12">
            <button type="submit" class="btn btn-primary w-100">
              Save Vital Signs
            </button>
          </div>
        </form>
      </div>

      <!-- Table -->
      <div>
        <h2>Recorded Vital Signs</h2>
        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle">
            <thead>
              <tr>
                <th>Time</th>
                <th>Systolic</th>
                <th>Diastolic</th>
                <th>SpO₂ %</th>
                <th>Pulse</th>
                <th>Temperature (°C)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="entriesTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Export / Delete Buttons -->
      <div class="mt-4">
        <button id="exportCSV" class="btn btn-warning w-100 mb-3">
          Export All Patients to CSV
        </button>
        <button id="exportCurrentPatient" class="btn btn-info w-100 mb-3">
          Export Current Patient to CSV
        </button>
        <button id="deletePatient" class="btn btn-danger w-100">
          Delete Current Patient
        </button>
        <button id="backupData" class="btn btn-secondary w-100 mt-3">
          Download Backup (JSON)
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let patients = {};
      let currentPatientID = "";

      const patientForm = document.getElementById("patientForm");
      const selectPatient = document.getElementById("selectPatient");
      const patientInfoDisplay = document.getElementById("patientInfoDisplay");
      const displayPatientName = document.getElementById("displayPatientName");
      const displayPatientDOB = document.getElementById("displayPatientDOB");
      const patientPhoto = document.getElementById("patientPhoto");
      const entriesTable = document.getElementById("entriesTable");
      const vitalForm = document.getElementById("vitalForm");
      const darkModeSwitch = document.getElementById("darkModeSwitch");

      function savePatientsToStorage() {
        localStorage.setItem("vitalsData", JSON.stringify(patients));
      }

      function loadPatientsFromStorage() {
        const savedData = localStorage.getItem("vitalsData");
        if (savedData) {
          patients = JSON.parse(savedData);
          for (const id in patients) {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `${patients[id].name} (${patients[id].dob})`;
            selectPatient.appendChild(option);
          }
        }
      }

      patientForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const name = document.getElementById("patientName").value;
        const dob = document.getElementById("dob").value;
        const fileInput = document.getElementById("patientImage");

        if (patients[dob]) {
          alert("Patient with this DOB already exists!");
          return;
        }

        // Handle image upload as Base64
        if (fileInput.files.length > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const imageBase64 = e.target.result;
            addPatient(name, dob, imageBase64);
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          addPatient(name, dob, "");
        }
      });

      function addPatient(name, dob, image) {
        patients[dob] = { name, dob, image, entries: [] };
        const option = document.createElement("option");
        option.value = dob;
        option.textContent = `${name} (${dob})`;
        selectPatient.appendChild(option);
        patientForm.reset();
        savePatientsToStorage();
      }

      selectPatient.addEventListener("change", function () {
        currentPatientID = this.value;
        if (!currentPatientID) {
          patientInfoDisplay.classList.add("d-none");
          entriesTable.innerHTML = "";
          return;
        }
        const patient = patients[currentPatientID];
        displayPatientName.textContent = patient.name;
        displayPatientDOB.textContent = patient.dob;
        if (patient.image) {
          patientPhoto.src = patient.image;
          patientPhoto.classList.remove("d-none");
        } else {
          patientPhoto.classList.add("d-none");
        }
        patientInfoDisplay.classList.remove("d-none");
        renderEntries();
      });

      vitalForm.addEventListener("submit", function (event) {
        event.preventDefault();
        if (!currentPatientID) {
          alert("Please select a patient first.");
          return;
        }
        const systolic = document.getElementById("systolic").value;
        const diastolic = document.getElementById("diastolic").value;
        const spo2 = document.getElementById("spo2").value;
        const pulse = document.getElementById("pulse").value;
        const temperature = document.getElementById("temperature").value;
        const timeInput = document.getElementById("time").value;

        const date = new Date(timeInput);
        const formattedTime = date.toLocaleString("en-GB", {
          dateStyle: "long",
          timeStyle: "short",
        });

        patients[currentPatientID].entries.push({
          time: formattedTime,
          systolic,
          diastolic,
          spo2,
          pulse,
          temperature,
        });

        vitalForm.reset();
        document.getElementById("time").value = new Date()
          .toISOString()
          .slice(0, 16);
        renderEntries();
        savePatientsToStorage();
      });

      function renderEntries() {
        entriesTable.innerHTML = "";
        if (!currentPatientID) return;
        patients[currentPatientID].entries.forEach((entry, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${entry.time}</td>
            <td>${entry.systolic}</td>
            <td>${entry.diastolic}</td>
            <td>${entry.spo2}</td>
            <td>${entry.pulse}</td>
            <td>${entry.temperature}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteEntry(${index})">Delete</button></td>
          `;
          entriesTable.appendChild(row);
        });
      }

      function deleteEntry(index) {
        if (!currentPatientID) return;
        if (confirm("Are you sure you want to delete this entry?")) {
          patients[currentPatientID].entries.splice(index, 1);
          savePatientsToStorage();
          renderEntries();
        }
      }

      document
        .getElementById("exportCSV")
        .addEventListener("click", function () {
          if (Object.keys(patients).length === 0) {
            alert("No patient data to export.");
            return;
          }
          let csv =
            "Patient Name,DOB,Time,Systolic,Diastolic,SpO₂ %,Pulse,Temperature (°C)\n";
          for (const id in patients) {
            const patient = patients[id];
            if (patient.entries.length === 0) {
              csv += `"${patient.name}","${patient.dob}","","","","","",""\n`;
            } else {
              patient.entries.forEach((entry) => {
                csv += `"${patient.name}","${patient.dob}","${entry.time}","${entry.systolic}","${entry.diastolic}","${entry.spo2}","${entry.pulse}","${entry.temperature}"\n`;
              });
            }
          }
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "vital_signs_data.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });

      document
        .getElementById("exportCurrentPatient")
        .addEventListener("click", function () {
          if (!currentPatientID) {
            alert("Please select a patient first.");
            return;
          }
          const patient = patients[currentPatientID];
          let csv =
            "Patient Name,DOB,Time,Systolic,Diastolic,SpO₂ %,Pulse,Temperature (°C)\n";
          if (patient.entries.length === 0) {
            csv += `"${patient.name}","${patient.dob}","","","","","",""\n`;
          } else {
            patient.entries.forEach((entry) => {
              csv += `"${patient.name}","${patient.dob}","${entry.time}","${entry.systolic}","${entry.diastolic}","${entry.spo2}","${entry.pulse}","${entry.temperature}"\n`;
            });
          }
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${patient.name.replace(/\s+/g, "_")}_vital_signs.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });

      document
        .getElementById("deletePatient")
        .addEventListener("click", function () {
          if (!currentPatientID) {
            alert("Please select a patient first.");
            return;
          }
          if (confirm("Are you sure you want to delete this patient?")) {
            delete patients[currentPatientID];
            savePatientsToStorage();
            selectPatient
              .querySelector(`option[value="${currentPatientID}"]`)
              .remove();
            currentPatientID = "";
            patientInfoDisplay.classList.add("d-none");
            entriesTable.innerHTML = "";
            selectPatient.value = "";
          }
        });

      document
        .getElementById("backupData")
        .addEventListener("click", function () {
          if (Object.keys(patients).length === 0) {
            alert("No data to back up.");
            return;
          }
          const blob = new Blob([JSON.stringify(patients, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
          a.href = url;
          a.download = `vital_signs_backup_${timestamp}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });

      darkModeSwitch.addEventListener("change", function () {
        document.body.classList.toggle("dark-mode", this.checked);
      });

      document.getElementById("time").value = new Date()
        .toISOString()
        .slice(0, 16);
      loadPatientsFromStorage();
    </script>
  </body>
</html>
